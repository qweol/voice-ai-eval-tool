# éƒ¨ç½²æŒ‡å—

æœ¬æ–‡æ¡£æä¾›äº†å¤šç§éƒ¨ç½²è¿™ä¸ª Next.js è¯­éŸ³æœåŠ¡å¯¹æ¯”å·¥å…·çš„æ–¹æ³•ã€‚

## ğŸ“‹ éƒ¨ç½²å‰å‡†å¤‡

### 1. ç¯å¢ƒå˜é‡é…ç½®

åˆ›å»º `.env.local` æ–‡ä»¶ï¼ˆæˆ– `.env.production` ç”¨äºç”Ÿäº§ç¯å¢ƒï¼‰ï¼Œé…ç½® API å¯†é’¥ï¼š

```env
# é˜¿é‡Œäº‘é…ç½®
ALIYUN_ACCESS_KEY_ID=your_aliyun_access_key_id
ALIYUN_ACCESS_KEY_SECRET=your_aliyun_access_key_secret

# è…¾è®¯äº‘é…ç½®
TENCENT_SECRET_ID=your_tencent_secret_id
TENCENT_SECRET_KEY=your_tencent_secret_key

# ç™¾åº¦é…ç½®
BAIDU_API_KEY=your_baidu_api_key
BAIDU_SECRET_KEY=your_baidu_secret_key
```

### 2. æ„å»ºé¡¹ç›®

```bash
npm install
npm run build
```

---

## ğŸš€ éƒ¨ç½²æ–¹å¼

### æ–¹å¼ä¸€ï¼šæœ¬åœ°éƒ¨ç½²ï¼ˆç”Ÿäº§æ¨¡å¼ï¼‰

é€‚åˆï¼šå†…ç½‘éƒ¨ç½²ã€æœ¬åœ°æœåŠ¡å™¨

#### æ­¥éª¤ï¼š

1. **å®‰è£…ä¾èµ–å¹¶æ„å»º**
   ```bash
   npm install
   npm run build
   ```

2. **å¯åŠ¨ç”Ÿäº§æœåŠ¡å™¨**
   ```bash
   npm start
   ```
   é»˜è®¤è¿è¡Œåœ¨ `http://localhost:3000`

3. **ä½¿ç”¨ PM2 ç®¡ç†è¿›ç¨‹ï¼ˆæ¨èï¼‰**
   ```bash
   # å®‰è£… PM2
   npm install -g pm2
   
   # å¯åŠ¨åº”ç”¨
   pm2 start npm --name "voice-ai-eval" -- start
   
   # æŸ¥çœ‹çŠ¶æ€
   pm2 status
   
   # æŸ¥çœ‹æ—¥å¿—
   pm2 logs voice-ai-eval
   
   # è®¾ç½®å¼€æœºè‡ªå¯
   pm2 startup
   pm2 save
   ```

4. **é…ç½®åå‘ä»£ç†ï¼ˆå¯é€‰ï¼Œä½¿ç”¨ Nginxï¼‰**
   
   åˆ›å»º Nginx é…ç½® `/etc/nginx/sites-available/voice-ai-eval`ï¼š
   ```nginx
   server {
       listen 80;
       server_name your-domain.com;
       
       location / {
           proxy_pass http://localhost:3000;
           proxy_http_version 1.1;
           proxy_set_header Upgrade $http_upgrade;
           proxy_set_header Connection 'upgrade';
           proxy_set_header Host $host;
           proxy_cache_bypass $http_upgrade;
           proxy_set_header X-Real-IP $remote_addr;
           proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
           proxy_set_header X-Forwarded-Proto $scheme;
       }
       
       # æ–‡ä»¶ä¸Šä¼ å¤§å°é™åˆ¶
       client_max_body_size 50M;
   }
   ```
   
   å¯ç”¨é…ç½®ï¼š
   ```bash
   sudo ln -s /etc/nginx/sites-available/voice-ai-eval /etc/nginx/sites-enabled/
   sudo nginx -t
   sudo systemctl reload nginx
   ```

---

### æ–¹å¼äºŒï¼šDocker éƒ¨ç½²

é€‚åˆï¼šå®¹å™¨åŒ–éƒ¨ç½²ã€äº‘æœåŠ¡å™¨ã€Kubernetes

#### æ­¥éª¤ï¼š

1. **åˆ›å»º Dockerfile**

   é¡¹ç›®æ ¹ç›®å½•å·²åŒ…å« `Dockerfile`ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼Œè§ä¸‹æ–¹åˆ›å»ºè¯´æ˜ï¼‰

2. **æ„å»ºé•œåƒ**
   ```bash
   docker build -t voice-ai-eval:latest .
   ```

3. **è¿è¡Œå®¹å™¨**
   ```bash
   docker run -d \
     --name voice-ai-eval \
     -p 3000:3000 \
     --env-file .env.local \
     -v $(pwd)/public/audio:/app/public/audio \
     voice-ai-eval:latest
   ```

4. **ä½¿ç”¨ Docker Composeï¼ˆæ¨èï¼‰**

   åˆ›å»º `docker-compose.yml`ï¼š
   ```yaml
   version: '3.8'
   
   services:
     app:
       build: .
       ports:
         - "3000:3000"
       env_file:
         - .env.local
       volumes:
         - ./public/audio:/app/public/audio
       restart: unless-stopped
       healthcheck:
         test: ["CMD", "curl", "-f", "http://localhost:3000/api/health"]
         interval: 30s
         timeout: 10s
         retries: 3
   ```
   
   å¯åŠ¨ï¼š
   ```bash
   docker-compose up -d
   ```

---

### æ–¹å¼ä¸‰ï¼šVercel éƒ¨ç½²ï¼ˆæ¨èï¼‰

é€‚åˆï¼šå¿«é€Ÿéƒ¨ç½²ã€è‡ªåŠ¨ CI/CDã€å…¨çƒ CDN

#### æ­¥éª¤ï¼š

1. **å®‰è£… Vercel CLI**
   ```bash
   npm install -g vercel
   ```

2. **ç™»å½• Vercel**
   ```bash
   vercel login
   ```

3. **éƒ¨ç½²**
   ```bash
   vercel
   ```
   æŒ‰æç¤ºé€‰æ‹©é…ç½®ï¼Œé¦–æ¬¡éƒ¨ç½²ä¼šè¯¢é—®ï¼š
   - é¡¹ç›®åç§°
   - æ˜¯å¦è¦†ç›–ç°æœ‰é¡¹ç›®
   - ç¯å¢ƒå˜é‡é…ç½®

4. **é…ç½®ç¯å¢ƒå˜é‡**

   åœ¨ Vercel æ§åˆ¶å°ï¼š
   - è¿›å…¥é¡¹ç›®è®¾ç½® â†’ Environment Variables
   - æ·»åŠ æ‰€æœ‰éœ€è¦çš„ç¯å¢ƒå˜é‡ï¼ˆALIYUN_ACCESS_KEY_ID ç­‰ï¼‰

5. **ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²**
   ```bash
   vercel --prod
   ```

6. **è‡ªåŠ¨éƒ¨ç½²ï¼ˆGitHub é›†æˆï¼‰**

   - åœ¨ Vercel æ§åˆ¶å°è¿æ¥ GitHub ä»“åº“
   - æ¯æ¬¡ push åˆ° main åˆ†æ”¯è‡ªåŠ¨éƒ¨ç½²
   - æ”¯æŒé¢„è§ˆéƒ¨ç½²ï¼ˆPR è‡ªåŠ¨éƒ¨ç½²é¢„è§ˆç¯å¢ƒï¼‰

**æ³¨æ„äº‹é¡¹ï¼š**
- Vercel å…è´¹ç‰ˆæœ‰æ–‡ä»¶å¤§å°é™åˆ¶ï¼ˆä¸Šä¼ æ–‡ä»¶æœ€å¤§ 4.5MBï¼‰
- éŸ³é¢‘æ–‡ä»¶å­˜å‚¨å»ºè®®ä½¿ç”¨å¤–éƒ¨å­˜å‚¨ï¼ˆå¦‚ AWS S3ã€é˜¿é‡Œäº‘ OSSï¼‰
- Serverless å‡½æ•°æœ‰æ‰§è¡Œæ—¶é—´é™åˆ¶

---

### æ–¹å¼å››ï¼šRailway éƒ¨ç½²

é€‚åˆï¼šç®€å•éƒ¨ç½²ã€è‡ªåŠ¨ HTTPSã€æ•°æ®åº“é›†æˆ

#### æ­¥éª¤ï¼š

1. **è®¿é—® [Railway](https://railway.app/)**
   - ä½¿ç”¨ GitHub è´¦å·ç™»å½•
   - ç‚¹å‡» "New Project" â†’ "Deploy from GitHub repo"

2. **é€‰æ‹©ä»“åº“å¹¶éƒ¨ç½²**
   - é€‰æ‹©ä½ çš„ä»“åº“
   - Railway è‡ªåŠ¨æ£€æµ‹ Next.js é¡¹ç›®

3. **é…ç½®ç¯å¢ƒå˜é‡**
   - åœ¨é¡¹ç›®è®¾ç½®ä¸­æ·»åŠ ç¯å¢ƒå˜é‡
   - æˆ–ä½¿ç”¨ Railway CLIï¼š
     ```bash
     railway variables set ALIYUN_ACCESS_KEY_ID=your_key
     ```

4. **éƒ¨ç½²å®Œæˆ**
   - Railway è‡ªåŠ¨æä¾› HTTPS åŸŸå
   - æ”¯æŒè‡ªå®šä¹‰åŸŸå

---

### æ–¹å¼äº”ï¼šRender éƒ¨ç½²

é€‚åˆï¼šå…è´¹æ‰˜ç®¡ã€è‡ªåŠ¨éƒ¨ç½²ã€ç®€å•é…ç½®

#### æ­¥éª¤ï¼š

1. **è®¿é—® [Render](https://render.com/)**
   - æ³¨å†Œè´¦å·ï¼ˆæ”¯æŒ GitHub ç™»å½•ï¼‰
   - ç‚¹å‡» "New" â†’ "Web Service"

2. **è¿æ¥ä»“åº“**
   - é€‰æ‹© GitHub ä»“åº“
   - è‡ªåŠ¨æ£€æµ‹ä¸º Next.js é¡¹ç›®

3. **é…ç½®éƒ¨ç½²**
   - **Build Command**: `npm install && npm run build`
   - **Start Command**: `npm start`
   - **Environment**: `Node`

4. **æ·»åŠ ç¯å¢ƒå˜é‡**
   - åœ¨ Environment æ ‡ç­¾é¡µæ·»åŠ æ‰€æœ‰éœ€è¦çš„ç¯å¢ƒå˜é‡

5. **éƒ¨ç½²**
   - ç‚¹å‡» "Create Web Service"
   - è‡ªåŠ¨æ„å»ºå’Œéƒ¨ç½²

---

### æ–¹å¼å…­ï¼šé˜¿é‡Œäº‘/è…¾è®¯äº‘æœåŠ¡å™¨éƒ¨ç½²

é€‚åˆï¼šå›½å†…è®¿é—®ã€è‡ªæœ‰æœåŠ¡å™¨ã€å®Œå…¨æ§åˆ¶

#### æ­¥éª¤ï¼š

1. **å‡†å¤‡æœåŠ¡å™¨**
   - è´­ä¹°äº‘æœåŠ¡å™¨ï¼ˆæ¨è 2æ ¸4G ä»¥ä¸Šï¼‰
   - å®‰è£… Node.js 18+ å’Œ npm

2. **éƒ¨ç½²ä»£ç **
   ```bash
   # å…‹éš†ä»£ç 
   git clone your-repo-url
   cd voice-ai-eval-tool
   
   # å®‰è£…ä¾èµ–
   npm install
   
   # æ„å»º
   npm run build
   ```

3. **é…ç½®ç¯å¢ƒå˜é‡**
   ```bash
   # åˆ›å»º .env.local
   nano .env.local
   # æ·»åŠ æ‰€æœ‰ç¯å¢ƒå˜é‡
   ```

4. **ä½¿ç”¨ PM2 è¿è¡Œ**
   ```bash
   npm install -g pm2
   pm2 start npm --name "voice-ai-eval" -- start
   pm2 save
   pm2 startup
   ```

5. **é…ç½® Nginx åå‘ä»£ç†**
   - å‚è€ƒ"æ–¹å¼ä¸€"ä¸­çš„ Nginx é…ç½®
   - é…ç½® SSL è¯ä¹¦ï¼ˆLet's Encrypt å…è´¹è¯ä¹¦ï¼‰

6. **é…ç½®é˜²ç«å¢™**
   ```bash
   # å¼€æ”¾ 80 å’Œ 443 ç«¯å£
   sudo ufw allow 80
   sudo ufw allow 443
   ```

---

### æ–¹å¼ä¸ƒï¼šKubernetes éƒ¨ç½²

é€‚åˆï¼šå¤§è§„æ¨¡éƒ¨ç½²ã€é«˜å¯ç”¨ã€å®¹å™¨ç¼–æ’

#### æ­¥éª¤ï¼š

1. **åˆ›å»º Dockerfile**ï¼ˆè§ä¸‹æ–¹ï¼‰

2. **æ„å»ºå¹¶æ¨é€é•œåƒ**
   ```bash
   docker build -t your-registry/voice-ai-eval:latest .
   docker push your-registry/voice-ai-eval:latest
   ```

3. **åˆ›å»º Kubernetes é…ç½®**

   `k8s/deployment.yaml`:
   ```yaml
   apiVersion: apps/v1
   kind: Deployment
   metadata:
     name: voice-ai-eval
   spec:
     replicas: 3
     selector:
       matchLabels:
         app: voice-ai-eval
     template:
       metadata:
         labels:
           app: voice-ai-eval
       spec:
         containers:
         - name: app
           image: your-registry/voice-ai-eval:latest
           ports:
           - containerPort: 3000
           env:
           - name: ALIYUN_ACCESS_KEY_ID
             valueFrom:
               secretKeyRef:
                 name: voice-ai-secrets
                 key: aliyun-access-key-id
           # ... å…¶ä»–ç¯å¢ƒå˜é‡
   ```

   `k8s/service.yaml`:
   ```yaml
   apiVersion: v1
   kind: Service
   metadata:
     name: voice-ai-eval-service
   spec:
     selector:
       app: voice-ai-eval
     ports:
     - port: 80
       targetPort: 3000
     type: LoadBalancer
   ```

4. **éƒ¨ç½²**
   ```bash
   kubectl apply -f k8s/
   ```

---

## ğŸ“¦ åˆ›å»º Dockerfile

å¦‚æœé¡¹ç›®ä¸­æ²¡æœ‰ Dockerfileï¼Œåˆ›å»º `Dockerfile`ï¼š

```dockerfile
# ä½¿ç”¨å®˜æ–¹ Node.js è¿è¡Œæ—¶ä½œä¸ºåŸºç¡€é•œåƒ
FROM node:18-alpine AS base

# å®‰è£…ä¾èµ–é˜¶æ®µ
FROM base AS deps
WORKDIR /app

# å¤åˆ¶ package æ–‡ä»¶
COPY package.json package-lock.json* ./
RUN npm ci

# æ„å»ºé˜¶æ®µ
FROM base AS builder
WORKDIR /app
COPY --from=deps /app/node_modules ./node_modules
COPY . .

# è®¾ç½®ç¯å¢ƒå˜é‡
ENV NEXT_TELEMETRY_DISABLED 1

# æ„å»ºåº”ç”¨
RUN npm run build

# ç”Ÿäº§é•œåƒ
FROM base AS runner
WORKDIR /app

ENV NODE_ENV production
ENV NEXT_TELEMETRY_DISABLED 1

RUN addgroup --system --gid 1001 nodejs
RUN adduser --system --uid 1001 nextjs

# å¤åˆ¶å¿…è¦æ–‡ä»¶
COPY --from=builder /app/public ./public
COPY --from=builder --chown=nextjs:nodejs /app/.next/standalone ./
COPY --from=builder --chown=nextjs:nodejs /app/.next/static ./.next/static

USER nextjs

EXPOSE 3000

ENV PORT 3000
ENV HOSTNAME "0.0.0.0"

CMD ["node", "server.js"]
```

**æ³¨æ„**ï¼šéœ€è¦åœ¨ `next.config.js` ä¸­å¯ç”¨ standalone è¾“å‡ºï¼š

```javascript
const nextConfig = {
  output: 'standalone',
  experimental: {
    serverActions: {
      bodySizeLimit: '50mb',
    },
  },
}
```

åˆ›å»º `.dockerignore`ï¼š

```
node_modules
.next
.git
.env*.local
.DS_Store
*.log
npm-debug.log*
public/audio/*
!public/audio/.gitkeep
```

---

## ğŸ”’ å®‰å…¨å»ºè®®

1. **ç¯å¢ƒå˜é‡å®‰å…¨**
   - ä¸è¦å°† `.env.local` æäº¤åˆ° Git
   - ä½¿ç”¨å¯†é’¥ç®¡ç†æœåŠ¡ï¼ˆå¦‚ AWS Secrets Managerã€Vaultï¼‰
   - å®šæœŸè½®æ¢ API å¯†é’¥

2. **HTTPS é…ç½®**
   - ç”Ÿäº§ç¯å¢ƒå¿…é¡»ä½¿ç”¨ HTTPS
   - é…ç½® SSL è¯ä¹¦ï¼ˆLet's Encrypt å…è´¹ï¼‰

3. **æ–‡ä»¶ä¸Šä¼ é™åˆ¶**
   - é™åˆ¶æ–‡ä»¶å¤§å°å’Œç±»å‹
   - å®šæœŸæ¸…ç†ä¸´æ—¶éŸ³é¢‘æ–‡ä»¶

4. **è®¿é—®æ§åˆ¶**
   - è€ƒè™‘æ·»åŠ èº«ä»½éªŒè¯ï¼ˆå¦‚ NextAuth.jsï¼‰
   - é™åˆ¶ API è°ƒç”¨é¢‘ç‡

---

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–

1. **å¯ç”¨ Next.js ç¼“å­˜**
   - é™æ€èµ„æº CDN
   - ISRï¼ˆå¢é‡é™æ€å†ç”Ÿï¼‰

2. **éŸ³é¢‘æ–‡ä»¶å­˜å‚¨**
   - ä½¿ç”¨å¯¹è±¡å­˜å‚¨ï¼ˆOSS/S3ï¼‰è€Œéæœ¬åœ°æ–‡ä»¶ç³»ç»Ÿ
   - é…ç½® CDN åŠ é€Ÿ

3. **æ•°æ®åº“ï¼ˆå¦‚éœ€è¦ï¼‰**
   - ä½¿ç”¨ Redis ç¼“å­˜ API å“åº”
   - è®°å½•å†å²å¯¹æ¯”ç»“æœ

---

## ğŸ› æ•…éšœæ’æŸ¥

### å¸¸è§é—®é¢˜

1. **æ„å»ºå¤±è´¥**
   ```bash
   # æ¸…ç†ç¼“å­˜
   rm -rf .next node_modules
   npm install
   npm run build
   ```

2. **ç«¯å£è¢«å ç”¨**
   ```bash
   # æŸ¥æ‰¾å ç”¨è¿›ç¨‹
   lsof -i :3000
   # æˆ–ä¿®æ”¹ç«¯å£
   PORT=3001 npm start
   ```

3. **ç¯å¢ƒå˜é‡æœªç”Ÿæ•ˆ**
   - ç¡®è®¤æ–‡ä»¶åæ­£ç¡®ï¼ˆ`.env.local` æˆ– `.env.production`ï¼‰
   - é‡å¯åº”ç”¨
   - æ£€æŸ¥å˜é‡åæ‹¼å†™

4. **æ–‡ä»¶ä¸Šä¼ å¤±è´¥**
   - æ£€æŸ¥ `next.config.js` ä¸­çš„ `bodySizeLimit` é…ç½®
   - æ£€æŸ¥æœåŠ¡å™¨ç£ç›˜ç©ºé—´
   - æ£€æŸ¥æ–‡ä»¶æƒé™

---

## ğŸ“ éƒ¨ç½²æ£€æŸ¥æ¸…å•

- [ ] ç¯å¢ƒå˜é‡å·²é…ç½®
- [ ] é¡¹ç›®æ„å»ºæˆåŠŸï¼ˆ`npm run build`ï¼‰
- [ ] ç”Ÿäº§æ¨¡å¼æµ‹è¯•é€šè¿‡ï¼ˆ`npm start`ï¼‰
- [ ] HTTPS å·²é…ç½®ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
- [ ] åŸŸåå·²è§£æï¼ˆå¦‚ä½¿ç”¨è‡ªå®šä¹‰åŸŸåï¼‰
- [ ] é˜²ç«å¢™è§„åˆ™å·²é…ç½®
- [ ] æ—¥å¿—ç›‘æ§å·²è®¾ç½®
- [ ] å¤‡ä»½ç­–ç•¥å·²åˆ¶å®š
- [ ] æ€§èƒ½ç›‘æ§å·²é…ç½®

---

## ğŸ¯ æ¨èæ–¹æ¡ˆ

- **å¿«é€ŸåŸå‹/æ¼”ç¤º**: Vercelï¼ˆ5åˆ†é’Ÿéƒ¨ç½²ï¼‰
- **å›½å†…è®¿é—®**: é˜¿é‡Œäº‘/è…¾è®¯äº‘æœåŠ¡å™¨ + PM2
- **å®¹å™¨åŒ–éƒ¨ç½²**: Docker + Docker Compose
- **å¤§è§„æ¨¡ç”Ÿäº§**: Kubernetes
- **ç®€å•æ‰˜ç®¡**: Railway æˆ– Render

é€‰æ‹©æœ€é€‚åˆä½ éœ€æ±‚çš„éƒ¨ç½²æ–¹å¼å³å¯ï¼




