# 模板系统使用说明

## 🎯 新功能概述

重构后的模板系统支持**无需改代码**即可添加新的服务商模板！

## 📋 主要改进

### 1. 模板配置化
- ✅ 模板不再硬编码在代码中
- ✅ 支持用户自定义模板
- ✅ 支持模板导入/导出
- ✅ 支持从URL加载远程模板

### 2. 动态模板注册
- ✅ 内置模板（OpenAI、Qwen、豆包、自定义）
- ✅ 用户自定义模板（存储在localStorage）
- ✅ 社区模板（可从URL加载）

### 3. 模板管理UI
- ✅ 查看所有模板（内置+自定义）
- ✅ 导入模板（文件或JSON）
- ✅ 导出模板
- ✅ 删除自定义模板

---

## 🚀 快速开始

### 方式一：使用内置模板（无需配置）

1. 进入**设置页面**
2. 点击 **"+ 添加API"**
3. 选择模板类型（OpenAI风格、Qwen风格、豆包风格等）
4. 填写API密钥和地址
5. 保存即可使用

### 方式二：导入自定义模板（推荐）

#### 示例：添加Kimi模板

1. **准备模板JSON文件**

   使用项目根目录的 `templates/kimi-template.json` 作为参考，或创建自己的模板：

```json
[
  {
    "id": "kimi",
    "name": "Kimi (Moonshot)",
    "description": "适用于Moonshot AI的Kimi语音服务",
    "defaultApiUrl": "https://api.moonshot.cn/v1",
    "defaultMethod": "POST",
    "authType": "bearer",
    "requestBodyTemplate": {
      "asr": "{\"model\": \"{model}\", \"file\": \"{audio}\", \"language\": \"{language}\"}",
      "tts": "{\"model\": \"{model}\", \"input\": \"{text}\", \"voice\": \"{voice}\"}"
    },
    "responseTextPath": "text",
    "responseAudioFormat": "stream",
    "models": [...]
  }
]
```

2. **导入模板**

   - 进入**设置页面** → **模板管理**
   - 点击 **"📥 导入模板"**
   - 选择文件或粘贴JSON
   - 点击 **"确认导入"**

3. **使用模板**

   - 在**API管理**中添加新API
   - 选择模板类型为 **"Kimi (Moonshot)"**
   - 填写API密钥
   - 保存即可使用

---

## 📝 模板格式说明

### 必需字段

```typescript
{
  "id": string;              // 模板唯一ID（不能与内置模板冲突）
  "name": string;            // 模板显示名称
  "description": string;     // 模板描述
  "defaultApiUrl": string;   // 默认API地址
  "defaultMethod": "POST";   // HTTP方法
  "authType": "bearer";      // 认证类型：bearer | apikey | custom
  "requestBodyTemplate": {
    "asr": string;           // ASR请求体模板（JSON字符串，支持变量）
    "tts": string;           // TTS请求体模板
  }
}
```

### 可选字段

```typescript
{
  "responseTextPath": string;        // ASR响应文本路径，如 "text" 或 "result.text"
  "responseAudioPath": string;      // TTS响应音频路径
  "responseAudioFormat": "stream";  // 音频格式：base64 | url | binary | stream
  "errorPath": string;              // 错误信息路径，如 "error.message"
  "models": ModelDefinition[];      // 预设模型列表
  "defaultModel": {
    "asr": string;                  // 默认ASR模型ID
    "tts": string;                  // 默认TTS模型ID
  },
  "allowCustomModel": boolean;      // 是否允许自定义模型
  "author": string;                 // 模板作者
  "version": string;                // 模板版本
}
```

### 支持的变量

在请求体模板中可以使用以下变量：

- `{text}` - TTS文本
- `{audio}` / `{audioBase64}` - ASR音频（base64编码）
- `{model}` - 模型名称
- `{voice}` - 音色ID
- `{language}` - 语言代码
- `{format}` - 音频格式
- `{speed}` - 语速
- `{volume}` - 音量
- `{pitch}` - 音调

---

## 🔧 高级用法

### 从URL加载模板

```typescript
import { loadTemplatesFromUrl } from '@/lib/providers/generic/template-loader';

// 从远程URL加载模板
const templates = await loadTemplatesFromUrl('https://example.com/templates.json');
```

### 编程方式添加模板

```typescript
import { addUserTemplate } from '@/lib/providers/generic/template-loader';

const newTemplate = await addUserTemplate({
  id: 'my-custom-provider',
  name: '我的自定义服务商',
  description: '...',
  defaultApiUrl: 'https://api.example.com',
  // ... 其他配置
});
```

### 导出模板

```typescript
import { exportTemplates } from '@/lib/providers/generic/template-loader';

// 导出用户自定义模板
const json = await exportTemplates();
console.log(json);
```

---

## 💡 最佳实践

### 1. 模板ID命名

- ✅ 使用小写字母和连字符：`kimi`, `my-custom-provider`
- ❌ 避免与内置模板冲突：不要使用 `openai`, `qwen`, `doubao`, `custom`

### 2. 请求体模板

- ✅ 使用JSON格式，支持变量替换
- ✅ 使用 `JSON.stringify()` 格式化，便于阅读
- ✅ 测试变量替换是否正确

### 3. 响应路径

- ✅ 使用点号分隔的路径：`result.text`, `data.output.text`
- ✅ 支持数组索引：`data[0].text`
- ✅ 测试路径是否正确提取数据

### 4. 模型定义

- ✅ 提供完整的模型信息（名称、描述、支持的语言/格式）
- ✅ 定义音色列表（TTS模型）
- ✅ 设置合理的默认模型

---

## 🐛 故障排查

### 问题1：模板导入失败

**原因**：JSON格式错误或缺少必需字段

**解决**：
1. 检查JSON格式是否正确
2. 确保包含所有必需字段（id, name, description等）
3. 查看浏览器控制台错误信息

### 问题2：模板ID冲突

**原因**：模板ID与内置模板重复

**解决**：
1. 修改模板ID为唯一值
2. 检查是否使用了 `openai`, `qwen`, `doubao`, `custom`

### 问题3：API调用失败

**原因**：请求体模板或响应路径配置错误

**解决**：
1. 检查请求体模板中的变量是否正确
2. 验证响应路径是否能正确提取数据
3. 查看API文档确认格式

---

## 📚 示例模板

项目提供了以下示例模板：

- `templates/kimi-template.json` - Kimi (Moonshot) 模板示例

更多模板示例请参考项目文档或社区分享。

---

## 🎉 总结

通过新的模板系统，你可以：

1. ✅ **无需改代码**即可添加新服务商
2. ✅ **导入/导出**模板，方便分享
3. ✅ **自定义**任意API格式
4. ✅ **社区贡献**模板，共同完善

开始使用吧！🚀

