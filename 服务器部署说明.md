# 服务器部署说明 - SSH 公钥认证

## 📖 什么是 SSH 公钥？

**SSH 公钥**是一种安全的身份验证方式，用于：
- 🔐 **无密码登录服务器**：不需要每次输入密码
- 🛡️ **更安全**：比密码登录更安全，难以被破解
- 🚀 **自动化部署**：方便 CI/CD 和自动化脚本

**工作原理：**
1. 你有一对密钥：**私钥**（保密，在你电脑上）和**公钥**（可以公开）
2. 你把**公钥**发给服务器管理员
3. 管理员把你的公钥添加到服务器的授权列表
4. 之后你就可以用**私钥**直接登录服务器，无需密码

---

## 🔑 你的 SSH 公钥

你的 SSH 公钥文件位于：`~/.ssh/id_ed25519.pub`

**公钥内容：**
```
（见下方命令输出）
```

**⚠️ 重要提示：**
- ✅ **公钥可以安全地发送给任何人**（包括你的上级）
- ❌ **私钥（id_ed25519，没有.pub后缀）绝对不能泄露！**

---

## 📤 如何发送公钥给上级

### 方法一：直接复制公钥内容

运行以下命令查看公钥：

```bash
cat ~/.ssh/id_ed25519.pub
```

复制输出的全部内容（通常是一行，以 `ssh-ed25519` 开头），发送给上级。

### 方法二：发送公钥文件

```bash
# 复制公钥到剪贴板（macOS）
cat ~/.ssh/id_ed25519.pub | pbcopy

# 或者直接打开文件
open ~/.ssh/id_ed25519.pub
```

---

## 🚀 获得权限后的部署流程

上级添加你的公钥后，你会收到：
- **服务器 IP 地址**（例如：`123.456.789.0`）
- **用户名**（通常是 `root` 或 `ubuntu`）
- **端口号**（通常是 `22`）

### 步骤 1：测试连接

```bash
# 测试能否连接服务器
ssh 用户名@服务器IP

# 例如：
ssh root@123.456.789.0
# 或指定端口
ssh -p 22 root@123.456.789.0
```

如果连接成功，说明权限已开通！

### 步骤 2：准备部署代码

在本地项目目录：

```bash
# 确保代码已提交到 Git（如果有）
git add .
git commit -m "准备部署"
git push

# 或者直接打包代码
tar -czf voice-ai-eval-tool.tar.gz \
  --exclude='node_modules' \
  --exclude='.next' \
  --exclude='.git' \
  --exclude='public/audio' \
  .
```

### 步骤 3：上传代码到服务器

**方法 A：使用 SCP（推荐）**

```bash
# 上传整个项目目录
scp -r /Users/caiwu/Desktop/voice-ai-eval-tool \
  用户名@服务器IP:/opt/voice-ai-eval-tool

# 或上传压缩包
scp voice-ai-eval-tool.tar.gz 用户名@服务器IP:/opt/
```

**方法 B：使用 Git（如果服务器有 Git）**

```bash
# SSH 到服务器
ssh 用户名@服务器IP

# 在服务器上克隆代码
cd /opt
git clone your-repo-url voice-ai-eval-tool
cd voice-ai-eval-tool
```

### 步骤 4：在服务器上部署

```bash
# SSH 登录服务器
ssh 用户名@服务器IP

# 进入项目目录
cd /opt/voice-ai-eval-tool

# 安装 Node.js（如果还没有）
# Ubuntu/Debian:
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt-get install -y nodejs

# 或使用 nvm:
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash
source ~/.bashrc
nvm install 18
nvm use 18

# 安装依赖
npm install

# 配置环境变量
nano .env.local
# 或
vi .env.local
# 添加所有 API 密钥

# 构建项目
npm run build

# 使用 PM2 启动（推荐）
npm install -g pm2
pm2 start npm --name "voice-ai-eval" -- start
pm2 save
pm2 startup  # 设置开机自启
```

### 步骤 5：配置 Nginx 反向代理（可选）

```bash
# 安装 Nginx
sudo apt-get update
sudo apt-get install nginx

# 创建配置文件
sudo nano /etc/nginx/sites-available/voice-ai-eval
```

配置文件内容：

```nginx
server {
    listen 80;
    server_name your-domain.com;  # 或服务器IP

    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # 文件上传大小限制
    client_max_body_size 50M;
}
```

启用配置：

```bash
sudo ln -s /etc/nginx/sites-available/voice-ai-eval /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx
```

### 步骤 6：配置防火墙

```bash
# 开放端口
sudo ufw allow 22    # SSH
sudo ufw allow 80    # HTTP
sudo ufw allow 443   # HTTPS（如果配置了SSL）
sudo ufw enable
```

---

## 🐳 使用 Docker 部署（更简单）

如果服务器支持 Docker，部署会更简单：

### 在本地构建并上传

```bash
# 构建 Docker 镜像
docker build -t voice-ai-eval:latest .

# 保存为 tar 文件
docker save voice-ai-eval:latest | gzip > voice-ai-eval.tar.gz

# 上传到服务器
scp voice-ai-eval.tar.gz 用户名@服务器IP:/opt/
```

### 在服务器上运行

```bash
# SSH 到服务器
ssh 用户名@服务器IP

# 加载镜像
docker load < /opt/voice-ai-eval.tar.gz

# 创建环境变量文件
nano /opt/.env.local
# 添加所有环境变量

# 运行容器
docker run -d \
  --name voice-ai-eval \
  -p 3000:3000 \
  --env-file /opt/.env.local \
  -v /opt/voice-ai-eval-audio:/app/public/audio \
  --restart unless-stopped \
  voice-ai-eval:latest
```

---

## 📝 快速部署脚本

创建一个自动化部署脚本 `deploy.sh`：

```bash
#!/bin/bash

# 配置
SERVER="用户名@服务器IP"
REMOTE_DIR="/opt/voice-ai-eval-tool"
LOCAL_DIR="/Users/caiwu/Desktop/voice-ai-eval-tool"

echo "🚀 开始部署..."

# 1. 构建项目
echo "📦 构建项目..."
cd $LOCAL_DIR
npm run build

# 2. 上传代码
echo "📤 上传代码..."
rsync -avz --exclude 'node_modules' --exclude '.next' --exclude '.git' \
  $LOCAL_DIR/ $SERVER:$REMOTE_DIR/

# 3. 在服务器上安装依赖和重启
echo "🔄 在服务器上安装依赖..."
ssh $SERVER "cd $REMOTE_DIR && npm install --production && pm2 restart voice-ai-eval || pm2 start npm --name voice-ai-eval -- start"

echo "✅ 部署完成！"
```

使用：

```bash
chmod +x deploy.sh
./deploy.sh
```

---

## 🔍 常见问题

### Q1: 连接被拒绝？
- 检查 IP 地址和端口是否正确
- 确认上级已添加你的公钥
- 检查防火墙设置

### Q2: 权限被拒绝？
- 确认使用的是正确的用户名
- 检查公钥是否正确添加到服务器

### Q3: 如何更新代码？
```bash
# 方法1：重新上传
scp -r 项目目录 用户名@服务器IP:/opt/voice-ai-eval-tool

# 方法2：使用 Git（如果服务器有）
ssh 用户名@服务器IP
cd /opt/voice-ai-eval-tool
git pull
npm install
npm run build
pm2 restart voice-ai-eval
```

### Q4: 如何查看日志？
```bash
# PM2 日志
pm2 logs voice-ai-eval

# 或实时查看
pm2 logs voice-ai-eval --lines 100
```

---

## 📋 部署检查清单

- [ ] SSH 公钥已发送给上级
- [ ] 收到服务器 IP、用户名、端口信息
- [ ] 成功 SSH 连接到服务器
- [ ] 代码已上传到服务器
- [ ] 环境变量已配置（.env.local）
- [ ] 项目构建成功（npm run build）
- [ ] 应用已启动（PM2 或 Docker）
- [ ] 可以通过浏览器访问（http://服务器IP:3000）
- [ ] Nginx 反向代理已配置（如需要）
- [ ] 防火墙规则已配置

---

## 🎯 总结

1. **发送公钥**：把 `~/.ssh/id_ed25519.pub` 的内容发给上级
2. **等待权限**：上级添加公钥后会告诉你服务器信息
3. **测试连接**：用 `ssh` 命令测试能否连接
4. **部署代码**：上传代码到服务器
5. **启动服务**：在服务器上安装依赖、构建、启动

需要帮助时随时问我！




