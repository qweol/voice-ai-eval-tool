// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// 批量测试批次表
model BatchTest {
  id          String   @id @default(uuid())
  name        String   @db.VarChar(255)
  description String?  @db.Text
  category    String   @db.VarChar(50)
  tags        Json
  status      BatchTestStatus @default(DRAFT)

  // 测试类型：TTS 或 ASR
  testType    TestType @default(TTS) @map("test_type")

  config      Json     @default("{}")
  providers   Json

  // ASR 特有字段
  audioSource String?  @db.VarChar(255) @map("audio_source") // 音频来源（文件名或样本ID）
  language    String?  @db.VarChar(20)  // 识别语言

  totalCases     Int      @default(0) @map("total_cases")
  completedCases Int      @default(0) @map("completed_cases")
  failedCases    Int      @default(0) @map("failed_cases")
  successRate    Decimal? @db.Decimal(5, 2) @map("success_rate")
  avgDuration    Decimal? @db.Decimal(10, 2) @map("avg_duration")
  totalCost      Decimal? @db.Decimal(10, 4) @map("total_cost")

  createdBy   String   @default("system") @db.VarChar(100) @map("created_by")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  startedAt   DateTime? @map("started_at")
  completedAt DateTime? @map("completed_at")

  testCases   TestCase[]
  results     BatchTestResult[]
  baselines   ComparisonBaseline[]
  currentReports ComparisonReport[] @relation("CurrentBatch")

  @@index([status])
  @@index([category])
  @@index([testType])
  @@index([createdAt(sort: Desc)])
  @@map("batch_tests")
}

enum BatchTestStatus {
  DRAFT
  RUNNING
  COMPLETED
  FAILED
  PAUSED
}

enum TestType {
  TTS  // 语音合成测试
  ASR  // 语音识别测试
}

// 测试用例表
model TestCase {
  id            String   @id @default(uuid())
  batchId       String   @map("batch_id")
  batch         BatchTest @relation(fields: [batchId], references: [id], onDelete: Cascade)

  text          String   @db.Text
  category      String?  @db.VarChar(50)
  expectedVoice String?  @db.VarChar(100) @map("expected_voice")
  tags          Json
  metadata      Json     @default("{}")

  orderIndex    Int      @default(0) @map("order_index")

  createdAt     DateTime @default(now()) @map("created_at")

  results       BatchTestResult[]

  @@index([batchId])
  @@index([batchId, orderIndex])
  @@map("test_cases")
}

// 批量测试结果表
model BatchTestResult {
  id           String   @id @default(uuid())
  batchId      String   @map("batch_id")
  batch        BatchTest @relation(fields: [batchId], references: [id], onDelete: Cascade)
  testCaseId   String   @map("test_case_id")
  testCase     TestCase @relation(fields: [testCaseId], references: [id], onDelete: Cascade)
  provider     String   @db.VarChar(100)

  status       TestResultStatus
  audioUrl     String?  @db.Text @map("audio_url")
  duration     Decimal? @db.Decimal(10, 2)
  cost         Decimal? @db.Decimal(10, 4)

  technicalParams Json  @default("{}") @map("technical_params")
  userRating      Json? @map("user_rating")

  error        String?  @db.Text

  ttfb         Int?
  totalTime    Int?     @map("total_time")

  // 批量运行索引（第几次运行，从1开始）
  runIndex     Int      @default(1) @map("run_index")

  // ASR 特有字段
  recognizedText String?  @db.Text @map("recognized_text")  // 识别出的文本
  referenceText  String?  @db.Text @map("reference_text")   // 参考文本
  similarity     Decimal? @db.Decimal(5, 2)                 // 与参考文本的相似度
  avgSimilarity  Decimal? @db.Decimal(5, 2) @map("avg_similarity") // 与其他供应商结果的平均相似度
  confidence     Decimal? @db.Decimal(5, 2)                 // 识别置信度

  createdAt    DateTime @default(now()) @map("created_at")

  @@unique([batchId, testCaseId, provider, runIndex])
  @@index([batchId])
  @@index([testCaseId])
  @@index([provider])
  @@index([status])
  @@map("batch_test_results")
}

enum TestResultStatus {
  SUCCESS
  FAILED
  TIMEOUT
}

// 历史对比基线表
model ComparisonBaseline {
  id          String   @id @default(uuid())
  name        String   @db.VarChar(255)
  batchId     String   @map("batch_id")
  batch       BatchTest @relation(fields: [batchId], references: [id], onDelete: Cascade)
  description String?  @db.Text

  snapshot    Json

  createdBy   String   @default("system") @db.VarChar(100) @map("created_by")
  createdAt   DateTime @default(now()) @map("created_at")

  @@index([batchId])
  @@map("comparison_baselines")
}

// 对比报告表
model ComparisonReport {
  id               String   @id @default(uuid())
  name             String   @db.VarChar(255)
  currentBatchId   String   @map("current_batch_id")
  currentBatch     BatchTest @relation("CurrentBatch", fields: [currentBatchId], references: [id])
  baselineBatchIds Json     @map("baseline_batch_ids")

  summary          Json
  details          Json

  pdfUrl           String?  @db.Text @map("pdf_url")
  excelUrl         String?  @db.Text @map("excel_url")

  createdBy        String   @default("system") @db.VarChar(100) @map("created_by")
  createdAt        DateTime @default(now()) @map("created_at")

  @@index([currentBatchId])
  @@index([createdAt(sort: Desc)])
  @@map("comparison_reports")
}

// ASR 样本音频表
model AsrSample {
  id            String   @id @default(uuid())

  // 样本基本信息
  name          String   @db.VarChar(255)
  description   String?  @db.Text

  // 音频文件信息
  filename      String   @unique @db.VarChar(255)
  originalName  String   @db.VarChar(255) @map("original_name")
  fileSize      Int      @map("file_size")
  duration      Decimal? @db.Decimal(10, 2)
  format        String   @db.VarChar(20)

  // 音频技术参数
  sampleRate    Int?     @map("sample_rate")
  bitRate       Int?     @map("bit_rate")
  channels      Int?     @default(1)

  // 标签和元数据
  tags          Json     @default("[]")
  language      String   @default("zh") @db.VarChar(20)

  // 参考文本
  referenceText String?  @db.Text @map("reference_text")

  // 使用统计
  usageCount    Int      @default(0) @map("usage_count")
  lastUsedAt    DateTime? @map("last_used_at")

  // 元数据
  uploadedBy    String   @default("system") @db.VarChar(100) @map("uploaded_by")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  @@index([createdAt(sort: Desc)])
  @@index([language])
  @@index([usageCount(sort: Desc)])
  @@map("asr_samples")
}
